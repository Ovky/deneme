<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ovky Bilgi Yarışması - Nihai Sürüm</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
        .shadow-3xl { box-shadow: 0 35px 60px -15px rgba(0, 0, 0, 0.3); }
        .gradient-button { background-image: linear-gradient(to right, #6366f1 0%, #3b82f6 100%); }
        .gradient-button:hover { background-image: linear-gradient(to right, #4f46e5 0%, #2563eb 100%); }
    </style>
</head>
<body>

<div id="root"></div>
    <script type="text/babel">
        
window.__firebase_config = JSON.stringify({
    "apiKey": "AIzaSyCIguwhWSomYktTSv_qlt0wYzakte35FhY", 
    "authDomain": "ovkyoyun.firebaseapp.com",
    "projectId": "ovkyoyun", 
    "storageBucket": "ovkyoyun.firebasestorage.app",
    "messagingSenderId": "283924737233", 
    "appId": "1:283924737233:web:d4c2d2d4d3f81d4cc6e9f0" 
});

window.__app_id = JSON.parse(window.__firebase_config).projectId; 
window.__initial_auth_token = null;
    
    const { useState, useEffect, useCallback, useMemo } = React;
    const { initializeApp } = firebase;
    const { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = firebase.auth;
    const { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, query, where, getDocs, addDoc } = firebase.firestore;
    const { Loader, Zap, Users, LogIn, Crown, Play, Clipboard, X, Check, Home, User, Star, ArrowRight, Trophy, Medal, AlertTriangle, Lightbulb, List, Settings, Book, Flask, Scale, Dumbbell } = lucide;

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? initialAuthToken : null;

    const BASE_POINTS = 100;
    const MAX_SPEED_BONUS = 50;
    const ANSWER_WINDOW_SECONDS = 15;
    const APP_NAME = "Ovky Bilgi Yarışması";
    
    const CATEGORIES = [
        { key: 'General', label: 'Genel Kültür', icon: List },
        { key: 'History', label: 'Tarih', icon: Book },
        { key: 'Science', label: 'Bilim', icon: Flask },
        { key: 'Sports', label: 'Spor', icon: Dumbbell },
        { key: 'Literature', label: 'Edebiyat', icon: Scale },
    ];
    
    let app; 
    const AVATAR_LIST = ["adventurer/male/1", "adventurer/male/2", "adventurer/male/3", "adventurer/male/4", "adventurer/male/5", "adventurer/male/6", "adventurer/female/7", "adventurer/female/8", "adventurer/female/9", "adventurer/female/10"];

    const getAvatarUrl = (seed) => {
        const parts = seed.split('/');
        const uniqueSeed = parts[parts.length - 1];
        return `https://api.dicebear.com/8.x/adventurer/svg?seed=${uniqueSeed}&flip=true&radius=50`;
    };

    const ErrorDisplay = ({ message }) => (<div className="p-4 bg-red-100 text-red-700 border border-red-300 rounded-lg shadow-md mt-4"><p className="font-semibold">Hata:</p><p>{message}</p></div>);
    const generateRoomCode = () => { return Math.random().toString(36).substring(2, 10).toUpperCase(); };
    const generateQuizData = async (questionCount = 10, category = 'Genel Kültür', excludedThemes = []) => {
        const exclusionPrompt = excludedThemes.length > 0 ? `Daha önce sorulan temalardan (${excludedThemes.join(', ').substring(0, 500)}) KAÇININ. Cevabın yalnızca JSON formatında olmalıdır.` : 'Cevabın yalnızca JSON formatında olmalıdır.';
        const userQuery = `4 şıklı ve her şık için açıklama (rationale) içeren ${questionCount} adet ${category} sorusu hazırla. Türkçe karakter kullan.`;
        const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        const responseSchema = { type: "ARRAY", items: { type: "OBJECT", properties: { "question": { "type": "STRING" }, "options": { type: "ARRAY", items: { type: "OBJECT", properties: { "text": { "type": "STRING" }, "rationale": { "type": "STRING" } }, required: ["text", "rationale"] } }, "correctIndex": { "type": "INTEGER" } }, required: ["question", "options", "correctIndex"] } };

        const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: `Soruların zorluk seviyesi artan bir sırada olmalıdır. İlk %30 'Kolay', sonraki %40 'Orta', son %30 'Zor' olmalıdır. ${category} kategorisine odaklan. ${exclusionPrompt}` }] }, generationConfig: { responseMimeType: "application/json", responseSchema: responseSchema, temperature: 0.7 } };

        try {
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const result = await response.json();
            if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts) {
                const parsedData = JSON.parse(result.candidates[0].content.parts[0].text);
                return parsedData.slice(0, questionCount);
            }
            throw new Error("API, geçerli bir JSON yapısı döndürmedi.");
        } catch (error) {
            console.error("Quiz API Hatası:", error);
            return [{ "question": `API Hatası: ${category} kategorisinde örnek soru?`, "options": [{ "text": "Cevap A", "rationale": "Örnek A." }, { "text": "Cevap B", "rationale": "Örnek B." }, { "text": "Cevap C", "rationale": "Örnek C." }, { "text": "Cevap D", "rationale": "Örnek D." }], "correctIndex": 1 }];
        }
    };

    const analyzePerformance = async (quizData, score, totalQuestions) => {
        const answeredQuestions = quizData.map((q, index) => ({ question: q.question, correct: q.answeredIndex === q.correctIndex, difficulty: index < totalQuestions * 0.3 ? 'Kolay' : (index < totalQuestions * 0.7 ? 'Orta' : 'Zor') }));
        const userQuery = `Kullanıcı ${totalQuestions} sorudan oluşan bir bilgi yarışmasında ${score} puan aldı. İşte sorular ve cevap durumları: ${JSON.stringify(answeredQuestions)}. Raporda: 1. Güçlü olduğu zorluk seviyelerini belirt. 2. Geliştirmesi gereken zorluk seviyeleri veya genel temaları belirt. 3. Sonuç odaklı bir geri bildirim sağla.`;
        const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: "Sen bir quiz koçusun. Kibar, motive edici ve yapıcı bir dille geri bildirim sağla." }] }, generationConfig: { temperature: 0.8 } };

        try {
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const result = await response.json();
            return result.candidates && result.candidates[0] && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts[0] && result.candidates[0].content.parts[0].text || "Analiz alınamadı, lütfen tekrar deneyin.";
        } catch (error) {
            console.error("Analiz API Hatası:", error);
            return "API'ye erişim sırasında hata oluştu. Lütfen bağlantınızı kontrol edin.";
        }
    };

    const generateNickname = async (selectedAvatar) => {
        const userQuery = `Bu avatar (${selectedAvatar}) için, eğlenceli ve yaratıcı, 15 karakteri geçmeyen, tek kelimelik bir takma ad (nickname) öner. Cevabın sadece takma ad olmalıdır.`;
        const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const payload = { contents: [{ parts: [{ text: userQuery }] }], generationConfig: { temperature: 0.9 } };
        try {
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const result = await response.json();
            const rawNickname = result.candidates && result.candidates[0] && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts[0] && result.candidates[0].content.parts[0].text || "YapayZekaKoç";
            return rawNickname.trim().replace(/['".,]/g, '').substring(0, 15);
        } catch (error) {
            console.error("Nickname API Hatası:", error);
            return "HataNick";
        }
    };
    
    const getDeepExplanation = async (question) => {
        const userQuery = `Aşağıdaki bilgi yarışması sorusunun konusunu (cevap vermeden) kısaca ve eğitici bir şekilde açıkla. Cevabın 3 cümleyi geçmesin. Soru: "${question}"`;
        const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: "Kısa ve eğitici bilgi özetleri sağla." }] }, generationConfig: { temperature: 0.5 } };
        try {
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: 
            JSON.stringify(payload) });
            const result = await response.json();
            return result.candidates && result.candidates[0] && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts[0] && result.candidates[0].content.parts[0].text || "Açıklama alınamadı.";
        } catch (error) {
            console.error("Açıklama API Hatası:", error);
            return "Açıklama yüklenirken bir hata oluştu.";
        }
    };

    const App = () => {
        const [db, setDb] = useState(null);
        const [auth, setAuth] = useState(null);
        const [userId, setUserId] = useState(null);
        const [isAuthReady, setIsAuthReady] = useState(false);
        const [error, setError] = useState(null);
        const [loading, setLoading] = useState(false);
        const [localNickname, setLocalNickname] = useState('');
        const [selectedAvatar, setSelectedAvatar] = useState(AVATAR_LIST[0]); 
        const [gameMode, setGameMode] = useState('menu'); 
        const [roomId, setRoomId] = useState(null);
        const [roomData, setRoomData] = useState(null);
        const [deepExplanation, setDeepExplanation] = useState(null); 
        const [singlePlayerGame, setSinglePlayerGame] = useState({
            status: 'setup', quizData: [], currentIndex: 0, score: 0, questionCount: 10, selectedCategory: 'General', analysisResult: null
        });
        const [activeRooms, setActiveRooms] = useState([]);
        const [soloHistory, setSoloHistory] = useState([]);
        const handleGoToMenu = () => {
            setGameMode('menu'); setRoomId(null); setRoomData(null); setDeepExplanation(null); setActiveRooms([]); setError(null);
            setSinglePlayerGame(prev => ({ ...prev, status: 'setup', quizData: [], currentIndex: 0, score: 0, analysisResult: null }));
        };
        
        const isHost = useMemo(() => { return roomData && roomData.hostId === userId; }, [roomData, userId]);
        const getNickname = useCallback((id) => { return (roomData && roomData.players && roomData.players[id] && roomData.players[id].nickname || `Oyuncu ${id.substring(0, 4)}`); }, [roomData]);
        const getPlayerAvatar = useCallback((id) => { return getAvatarUrl(roomData && roomData.players && roomData.players[id] && roomData.players[id].avatar || AVATAR_LIST[0]); }, [roomData]);
        const getCategoryIcon = useCallback((key) => { return CATEGORIES.find(c => c.key === key) ? CATEGORIES.find(c => c.key === key).icon : List; }, []);
        
        // --- HOOKS ---
        useEffect(() => {
            if (Object.keys(firebaseConfig).length === 0) { setError("Firebase yapılandırması eksik."); setIsAuthReady(true); return; }
            try {
                if (!app) { app = initializeApp(firebaseConfig); }
                const firestoreDb = getFirestore(app); const firebaseAuth = getAuth(app); setDb(firestoreDb); setAuth(firebaseAuth);
                const unsubscribe = onAuthStateChanged(firebaseAuth, async (user) => {
                    if (!user) { try { if (initialAuthToken) { await signInWithCustomToken(firebaseAuth, initialAuthToken); } else { await signInAnonymously(firebaseAuth); } } catch (e) { setError("Kullanıcı doğrulama başarısız."); } } else { setUserId(user.uid); }
                    setIsAuthReady(true);
                });
                return () => unsubscribe();
            } catch (e) { setError("Firebase hizmetleri başlatılamadı."); setIsAuthReady(true); }
        }, []);

        useEffect(() => { if (!db || !roomId || gameMode !== 'online') return; const roomDocRef = doc(db, `artifacts/${appId}/public/data/rooms`, roomId); const unsubscribe = onSnapshot(roomDocRef, (docSnap) => { if (docSnap.exists()) { setRoomData(docSnap.data()); setDeepExplanation(null); } else { setRoomId(null); setRoomData(null); setGameMode('onlineLobby'); setError("Oda bağlantısı koptu veya oda silindi."); } }, (e) => { setError("Oda verileri alınamadı."); }); return () => unsubscribe(); }, [db, roomId, gameMode]);
        useEffect(() => { if (!db || gameMode !== 'onlineLobby') return; const roomsCollRef = collection(db, `artifacts/${appId}/public/data/rooms`); const q = query(roomsCollRef, where("status", "==", "waiting")); const unsubscribe = onSnapshot(q, (snapshot) => { setActiveRooms(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); }, (e) => { console.error("Genel Lobi Dinleme Hatası:", e); }); return () => unsubscribe(); }, [db, gameMode]);
        useEffect(() => { if (!db || !userId) return; const historyCollRef = collection(db, `artifacts/${appId}/users/${userId}/solo_history`); const q = query(historyCollRef); const unsubscribe = onSnapshot(q, (snapshot) => { const historyData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); historyData.sort((a, b) => b.score - a.score); setSoloHistory(historyData); }, (e) => { console.error("Tek kişilik skor geçmişi alınamadı:", e); }); return () => unsubscribe(); }, [db, userId]);
        useEffect(() => { if (!db || !roomId || !isHost || roomData?.status !== 'playing' || !roomData?.questionStartTime) return; const allAnswered = roomData.players && Object.values(roomData.players).every(p => p.latestAnswerTime !== null); const timeElapsed = (new Date().getTime() - roomData.questionStartTime) / 1000; if (allAnswered || timeElapsed >= ANSWER_WINDOW_SECONDS) { const timeout = setTimeout(() => { handleNextQuestionOnline(); }, 1000); return () => clearTimeout(timeout); } }, [db, roomId, isHost, roomData]);

        // --- ONLINE İŞLEVLERİ ---
        const handleCreateRoom = async (questionCount, category) => {
            if (!db || !userId || localNickname.trim() === '' || !selectedAvatar) return; setLoading(true); setError(null);
            try { 
                const uniqueCode = generateRoomCode(); const newRoomRef = doc(db, `artifacts/${appId}/public/data/rooms`, uniqueCode);
                const categoryLabel = CATEGORIES.find(c => c.key === category).label;
                const initialRoomData = { code: uniqueCode, hostId: userId, status: 'waiting', currentQuestionIndex: -1, quizData: [], questionCount: questionCount, category: categoryLabel, players: { [userId]: { score: 0, latestAnswerTime: null, isHost: true, nickname: localNickname.trim(), avatar: selectedAvatar } } };
                await setDoc(newRoomRef, initialRoomData); setRoomId(uniqueCode); setGameMode('online'); 
            } catch (e) { setError("Oda oluşturulurken bir hata oluştu: " + e.message); } finally { setLoading(false); }
        };

        const handleJoinRoomByClick = async (roomID) => {
            if (!db || !userId || localNickname.trim() === '' || !selectedAvatar) return; setLoading(true); setError(null);
            try { 
                const roomDocRef = doc(db, `artifacts/${appId}/public/data/rooms`, roomID); const roomDoc = await roomDocRef.get();
                if (!roomDoc.exists) { setError("Oda bulunamadı veya silinmiş."); setLoading(false); return; }
                const roomData = roomDoc.data();
                if (roomData.status !== 'waiting') { setError("Oyun zaten başladı."); setLoading(false); return; }
                const newPlayers = { ...roomData.players, [userId]: { score: roomData.players?.[userId]?.score || 0, latestAnswerTime: null, isHost: roomData.hostId === userId, nickname: localNickname.trim(), avatar: selectedAvatar } };
                await updateDoc(roomDocRef, { players: newPlayers }); setRoomId(roomDoc.id); setGameMode('online'); 
            } catch (e) { setError("Odaya katılırken bir hata oluştu. Lütfen tekrar deneyin."); } finally { setLoading(false); }
        };
        
        const handleStartGame = async () => {
            if (!isHost || !roomId || !db || !roomData?.questionCount || !roomData?.category) return; setLoading(true); setError(null);
            const excludedThemes = soloHistory.reduce((acc, game) => { if (game.category === roomData.category && game.quizHistory) { try { const history = JSON.parse(game.quizHistory); history.forEach(q => acc.add(q.question)); } catch (e) { } } return acc; }, new Set());
            try {
                const quiz = await generateQuizData(roomData.questionCount, roomData.category, Array.from(excludedThemes).slice(0, 50)); 
                if (quiz.length === 0) throw new Error("Soru üretilemedi.");
                const roomRef = doc(db, `artifacts/${appId}/public/data/rooms`, roomId);
                await updateDoc(roomRef, { status: 'playing', quizData: quiz, currentQuestionIndex: 0, questionStartTime: new Date().getTime() });
            } catch (e) { setError(e.message || "Oyun başlatılamadı veya sorular üretilemedi."); } finally { setLoading(false); }
        };

        const handleAnswerQuestionOnline = async (selectedIndex) => {
            if (!db || !roomId || !roomData || roomData.status !== 'playing') return; const playerState = roomData.players[userId]; const currentQuestion = roomData.quizData[roomData.currentQuestionIndex];
            if (playerState?.latestAnswerTime !== null) return;
            const isCorrect = selectedIndex === currentQuestion.correctIndex; const answerTime = new Date().getTime(); const timeTaken = (answerTime - roomData.questionStartTime) / 1000;
            let newScore = playerState.score; let newAnswerTime = answerTime;
            if (isCorrect) { let bonus = Math.floor(MAX_SPEED_BONUS * (1 - Math.min(1, timeTaken / ANSWER_WINDOW_SECONDS))); newScore += BASE_POINTS + Math.max(0, bonus); }
            const updatedPlayers = { ...roomData.players, [userId]: { ...playerState, score: newScore, latestAnswerTime: newAnswerTime, isCorrect: isCorrect, answeredIndex: selectedIndex, timeTaken: timeTaken } };
            const roomRef = doc(db, `artifacts/${appId}/public/data/rooms`, roomId); await updateDoc(roomRef, { players: updatedPlayers });
        };

        const handleNextQuestionOnline = async () => {
            if (!db || !roomId || !roomData || roomData.hostId !== userId) return;
            const nextIndex = roomData.currentQuestionIndex + 1; const totalQuestions = roomData.quizData.length;
            const roomRef = doc(db, `artifacts/${appId}/public/data/rooms`, roomId);
            const updatedPlayers = Object.fromEntries(Object.entries(roomData.players).map(([id, player]) => {
                const newPlayerState = player.latestAnswerTime === null ? { ...player, latestAnswerTime: new Date().getTime(), isCorrect: false, answeredIndex: -1, timeTaken: ANSWER_WINDOW_SECONDS } : player;
                return [id, newPlayerState];
            }));

            if (nextIndex < totalQuestions) {
                const resetPlayers = Object.fromEntries(Object.entries(updatedPlayers).map(([id, player]) => [id, { ...player, latestAnswerTime: null, isCorrect: null, answeredIndex: null, timeTaken: null }]));
                await updateDoc(roomRef, { currentQuestionIndex: nextIndex, questionStartTime: new Date().getTime(), players: resetPlayers });
            } else {
                await updateDoc(roomRef, { status: 'finished', players: updatedPlayers });
            }
        };
        // --- TEK KİŞİLİK İŞLEVLERİ ---
        const saveSoloGameResult = async (finalScore, count, category, nick, avatarUrl, quizHistory) => { /* ... */ };
        const handleStartSinglePlayer = async () => { /* ... */ };
        const handleAnswerSinglePlayer = (selectedIndex) => { /* ... */ };
        const handleNextSinglePlayer = async () => { /* ... */ };
        const handleAnalyzePerformance = async () => { /* ... */ };
        const handleNicknameSuggestion = async () => { /* ... */ };
        const CategorySelector = ({ selectedCategory, onSelectCategory }) => { /* ... */ };
        const QuestionCountSelector = ({ selectedCount, onSelectCount }) => { /* ... */ };
        const PlayerList = ({ players, userId, hostId, showAnswers = false, isOnlineGame = false }) => { /* ... */ };
        
        // --- Tüm Render Fonksiyonları (RenderMenu, RenderOnlineLobby, RenderOnlineGame, RenderSinglePlayerGame) ---

        const RenderMenu = () => (
            <div className="max-w-md mx-auto p-8 bg-white rounded-3xl shadow-2xl mt-16 text-center">
                <h1 className="text-4xl font-extrabold text-indigo-600 mb-6">{APP_NAME}</h1><p className="text-gray-600 mb-8">Nasıl oynamak istersiniz?</p>{error && <ErrorDisplay message={error} />}
                <div className="space-y-6">
                    <div className="mb-6"><h3 className="text-lg font-semibold text-gray-700 mb-3 flex items-center justify-center">Avatarını Seç</h3><div className="flex flex-wrap justify-center gap-2">
                            {AVATAR_LIST.map((avatarSeed, index) => (<img key={index} src={getAvatarUrl(avatarSeed)} alt={`avatar-${index}`} className={`w-12 h-12 rounded-full cursor-pointer border-2 transition-all ${selectedAvatar === avatarSeed ? 'border-indigo-600 ring-2 ring-indigo-300' : 'border-gray-300 hover:border-indigo-400'}`} onClick={() => setSelectedAvatar(avatarSeed)} onError={(e) => e.target.src = getAvatarUrl(AVATAR_LIST[0])}/>))}
                        </div></div>
                    <div className="relative"><input type="text" placeholder="Takma Adınız (Nick)" value={localNickname} onChange={(e) => setLocalNickname(e.target.value)} className="w-full px-4 py-3 pr-14 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" maxLength={15} />
                        <button onClick={handleNicknameSuggestion} disabled={loading} className="absolute right-0 top-0 h-full px-3 text-indigo-600 hover:text-indigo-800 disabled:opacity-50" title="AI'dan Takma Ad Önerisi Al">{loading ? <Loader className="w-5 h-5 animate-spin"/> : 'AI'}</button>
                    </div>
                    <button onClick={() => setGameMode('singlePlayer')} disabled={localNickname.trim() === '' || !selectedAvatar} className="w-full flex items-center justify-center px-6 py-3 border border-transparent text-lg font-medium rounded-xl shadow-lg text-white bg-green-600 hover:bg-green-700 disabled:opacity-50 transition duration-150 transform hover:scale-[1.01]"><User className="w-5 h-5 mr-2" />Tek Kişilik Oyna</button>
                    <button onClick={() => setGameMode('onlineLobby')} disabled={localNickname.trim() === '' || !selectedAvatar} className="w-full flex items-center justify-center px-6 py-3 border border-transparent text-lg font-medium rounded-xl shadow-lg text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 transition duration-150 transform hover:scale-[1.01]"><Users className="w-5 h-5 mr-2" />Online Oyna</button>
                </div>
            </div>
        );

        const RenderOnlineLobby = () => {
            const [questionCount, setQuestionCount] = useState(10);
            const [selectedCategory, setSelectedCategory] = useState('General');
            const formatTimestamp = (ts) => { if (!ts || !ts.seconds) return 'Bilinmiyor'; const date = new Date(ts.seconds * 1000); return date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }); };

            return (
                <div className="max-w-4xl mx-auto p-8 bg-white rounded-3xl shadow-2xl mt-10">
                    <button onClick={handleGoToMenu} className="flex items-center text-sm text-indigo-600 hover:underline mb-4"><Home className="w-4 h-4 mr-1"/>Ana Menü</button>
                    <h2 className="text-3xl font-bold text-indigo-600 mb-6 text-center">Genel Lobi</h2>{error && <ErrorDisplay message={error} />}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-1 p-4 border border-gray-200 rounded-xl shadow-md">
                            <h3 className="text-xl font-semibold text-center mb-4">Yeni Oda Kur</h3>
                            <CategorySelector selectedCategory={selectedCategory} onSelectCategory={setSelectedCategory} />
                            <QuestionCountSelector selectedCount={questionCount} onSelectCount={setQuestionCount} />
                            <button onClick={() => handleCreateRoom(questionCount, selectedCategory)} disabled={loading} className="w-full mt-4 flex items-center justify-center px-6 py-3 text-base font-medium rounded-xl shadow-sm text-white bg-green-600 hover:bg-green-700 disabled:opacity-50">
                                {loading ? <Loader className="w-5 h-5 animate-spin" /> : <Play className="w-5 h-5 mr-2" />}Oda Kur ve Başlat</button>
                        </div>

                        <div className="lg:col-span-2 p-4 border border-gray-200 rounded-xl shadow-md">
                            <h3 className="text-xl font-semibold text-center mb-4">Açık Odalar ({activeRooms.length})</h3>
                            <div className="space-y-3 max-h-96 overflow-y-auto">
                                {activeRooms.length === 0 ? (<p className="text-center text-gray-500 p-4">Şu anda açık oda bulunmamaktadır. Hemen bir oda kur!</p>) : (
                                    activeRooms.map(room => {
                                        const hostNickname = room.players[room.hostId]?.nickname || "Bilinmeyen Host";
                                        const CategoryIcon = getCategoryIcon(CATEGORIES.find(c => c.label === room.category)?.key || 'General');
                                        return (<div key={room.id} className="flex items-center justify-between p-3 bg-indigo-50 rounded-lg border border-indigo-200 shadow-sm">
                                            <div className="flex items-center space-x-3"><img src={getAvatarUrl(room.players[room.hostId]?.avatar)} alt="host avatar" className="w-8 h-8 rounded-full border-2 border-indigo-400" />
                                                <div className="text-left"><p className="font-bold text-gray-800">{hostNickname}</p><p className="text-sm text-gray-600 flex items-center">
                                                        <CategoryIcon className="w-4 h-4 mr-1"/> {room.category} ({room.questionCount} Soru)
                                                    </p></div></div>
                                            <button onClick={() => handleJoinRoomByClick(room.id)} disabled={loading || room.hostId === userId} className="px-4 py-2 text-sm font-medium rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400">
                                                {room.hostId === userId ? "Odam (Bekleniyor)" : `Katıl (${Object.keys(room.players).length})`}
                                            </button></div>);
                                    })
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        const RenderOnlineGame = () => { /* ... (Online Oyun Kodu) ... */ return (
            <div className="max-w-4xl mx-auto p-6">
                {/* Oynanıyor Ekranı */}
            </div>
        ); };

        const RenderSinglePlayerGame = () => { /* ... (Tek Kişilik Oyun Kodu) ... */ return (
             <div className="max-w-lg mx-auto p-8 bg-white rounded-3xl shadow-2xl mt-10">
                 {/* Kurulum/Oynanıyor/Sonuç Ekranları */}
             </div>
         ); };


        // --- ANA RENDER ---
        
        return (
            <div className="min-h-screen bg-gray-50 p-4 font-sans">
                <header className="py-4 text-center">
                    <h1 className="text-2xl md:text-3xl font-extrabold text-gray-800">{APP_NAME}</h1>
                </header>
                
                {gameMode === 'menu' && <RenderMenu />}
                {gameMode === 'onlineLobby' && <RenderOnlineLobby />}
                {gameMode === 'online' && <RenderOnlineGame />}
                {gameMode === 'singlePlayer' && <RenderSinglePlayerGame />}
                
                <footer className="text-center mt-10 text-xs text-gray-400">
                    Kullanıcı ID: {userId ? userId.substring(0, 10) : '...'}...
                </footer>
            </div>
        );
    };

    // React uygulamasını başlat
    ReactDOM.render(<App />, document.getElementById('root'));
</script>

</body>
</html>


